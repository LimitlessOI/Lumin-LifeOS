<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cost Metrics Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { 
      font-family: system-ui, -apple-system,
sans-serif; 
      padding: 20px; 
      max-width: 1200px; 
      margin: 0 auto; 
      background: #f8f9fa; 
    }
    h1 { color: #1e293b; margin-bottom: 8px; }
    .subtitle { color: #64748b; font-size: 14px; margin-bottom: 24px; }
    .card { 
      background: #fff; 
      border-radius: 12px; 
      padding: 24px; 
      margin: 16px 0; 
      box-shadow: 0 2px 8px rgba(0,0,0,.08); 
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .metric { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .metric.budget { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .metric.builds { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .metric.merged { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .metric-value { 
      font-size: 36px; 
      font-weight: 700; 
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-label { 
      font-size: 13px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      opacity: 0.9;
    }
    .budget-bar {
      background: #e2e8f0;
      border-radius: 8px;
      height: 24px;
      overflow: hidden;
      margin: 16px 0;
    }
    .budget-fill {
      background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #ef4444 100%);
      height: 100%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    table { 
      width: 100%; 
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td { 
      text-align: left; 
      padding: 12px; 
      border-bottom: 1px solid #e2e8f0; 
    }
    th { 
      background: #f8fafc; 
      font-weight: 600;
      color: #475569;
      position: sticky;
      top: 0;
    }
    tr:hover { background: #f8fafc; }
    .high-cost { 
      color: #dc2626; 
      font-weight: 600; 
    }
    .low-roi { background: #fef2f2; }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-merged { background: #d1fae5; color: #065f46; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-roi-check { background: #dbeafe; color: #1e40af; }
    .refresh-btn {
      background: #0ea5e9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .refresh-btn:hover { background: #0284c7; }
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: #94a3b8;
    }
    .loading {
      text-align: center;
      padding: 48px;
      color: #64748b;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .timestamp {
      font-size: 12px;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <h1>üí∞ Cost & ROI Dashboard</h1>
  <div class="subtitle">Real-time autopilot spend tracking ‚Ä¢ Last 7 days</div>
  
  <div class="metrics-grid">
    <div class="metric">
      <div class="metric-value" id="totalCost">$0.00</div>
      <div class="metric-label">Total Spend</div>
    </div>
    <div class="metric budget">
      <div class="metric-value" id="todaySpend">$0.00</div>
      <div class="metric-label">Today / $<span id="budgetLimit">5.00</span></div>
    </div>
    <div class="metric builds">
      <div class="metric-value" id="builds">0</div>
      <div class="metric-label">Total Builds</div>
    </div>
    <div class="metric merged">
      <div class="metric-value" id="merged">0</div>
      <div class="metric-label">Merged PRs</div>
    </div>
  </div>

  <div class="card">
    <div class="header-row">
      <h3 style="margin: 0;">Budget Status</h3>
      <button class="refresh-btn" onclick="loadMetrics()">üîÑ Refresh</button>
    </div>
    <div class="budget-bar">
      <div class="budget-fill" id="budgetBar" style="width: 0%;">0%</div>
    </div>
    <div id="budgetStatus" style="color: #64748b; font-size: 14px;"></div>
  </div>

  <div class="card">
    <h3>üî¥ High Cost Builds (Top 10)</h3>
    <div style="overflow-x: auto;">
      <table id="costTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Model</th>
            <th>Tokens In</th>
            <th>Tokens Out</th>
            <th>Cost</th>
            <th>PR</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="costTableBody">
          <tr><td colspan="7" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>üìâ Low ROI Builds</h3>
    <p style="color: #64748b; font-size: 13px; margin-top: 0;">Cost > $0.50 but not merged</p>
    <div style="overflow-x: auto;">
      <table id="lowRoiTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Summary</th>
            <th>Cost</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="lowRoiTableBody">
          <tr><td colspan="4" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div style="text-align: center; margin-top: 32px; color: #94a3b8; font-size: 12px;">
    <p>Last updated: <span id="lastUpdate">‚Äî</span></p>
    <p>Auto-refreshes every 30 seconds</p>
  </div>

  <script>
    const API_BASE = location.origin;
    const KEY = new URLSearchParams(location.search).get('key') || '';

    function formatTimestamp(ts) {
      const d = new Date(ts);
      return d.toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function getStatusBadge(status) {
      const classes = {
        'merged': 'status-merged',
        'pending': 'status-pending',
        'roi_check': 'status-roi-check',
        'pr_opened': 'status-pending'
      };
      const cls = classes[status] || 'status-pending';
      return `<span class="status-badge ${cls}">${status || 'pending'}</span>`;
    }

    async function loadMetrics() {
      try {
        // Load summary
        const summaryRes = await fetch(`${API_BASE}/api/v1/metrics/summary?key=${encodeURIComponent(KEY)}`);
        const data = await summaryRes.json();
        
        document.getElementById('totalCost').textContent = `$${Number(data.total_cost).toFixed(2)}`;
        document.getElementById('builds').textContent = data.build_count;
        document.getElementById('merged').textContent = data.merged_count;
        
        const avgCost = Number(data.avg_cost).toFixed(3);
        document.getElementById('builds').parentElement.querySelector('.metric-label').textContent = 
          `Total Builds (avg $${avgCost})`;

        // Load budget
        const budgetRes = await fetch(`${API_BASE}/api/v1/budget/status?key=${encodeURIComponent(KEY)}`);
        const budget = await budgetRes.json();
        
        const todaySpend = Number(budget.spent).toFixed(2);
        const limit = Number(budget.limit).toFixed(2);
        const percentage = Math.min(100, (budget.spent / budget.limit) * 100);
        
        document.getElementById('todaySpend').textContent = `$${todaySpend}`;
        document.getElementById('budgetLimit').textContent = limit;
        document.getElementById('budgetBar').style.width = `${percentage}%`;
        document.getElementById('budgetBar').textContent = `${percentage.toFixed(0)}%`;
        
        const remaining = Number(budget.remaining).toFixed(2);
        let statusMsg = `$${remaining} remaining today`;
        if (budget.exceeded) {
          statusMsg = `‚ö†Ô∏è Budget exceeded! No more builds until tomorrow.`;
          document.getElementById('budgetStatus').style.color = '#dc2626';
          document.getElementById('budgetStatus').style.fontWeight = '600';
        } else {
          document.getElementById('budgetStatus').style.color = '#64748b';
          document.getElementById('budgetStatus').style.fontWeight = '400';
        }
        document.getElementById('budgetStatus').textContent = statusMsg;

        // High cost table
        const costTbody = document.getElementById('costTableBody');
        if (data.high_cost.length === 0) {
          costTbody.innerHTML = '<tr><td colspan="7" class="empty-state">No builds yet</td></tr>';
        } else {
          costTbody.innerHTML = data.high_cost.map(b => `
            <tr>
              <td class="timestamp">${formatTimestamp(b.timestamp)}</td>
              <td><code>${b.model}</code></td>
              <td>${(b.tokens_in || 0).toLocaleString()}</td>
              <td>${(b.tokens_out || 0).toLocaleString()}</td>
              <td class="high-cost">$${Number(b.cost).toFixed(4)}</td>
              <td>${b.pr_url ? `<a href="${b.pr_url}" target="_blank">PR #${b.pr_url.split('/').pop()}</a>` : '‚Äî'}</td>
              <td>${getStatusBadge(b.outcome)}</td>
            </tr>
          `).join('');
        }

        // Low ROI table
        const lowRoiTbody = document.getElementById('lowRoiTableBody');
        if (data.low_roi.length === 0) {
          lowRoiTbody.innerHTML = '<tr><td colspan="4" class="empty-state">No low-ROI builds (good!)</td></tr>';
        } else {
          lowRoiTbody.innerHTML = data.low_roi.map(b => `
            <tr class="low-roi">
              <td class="timestamp">${formatTimestamp(b.timestamp)}</td>
              <td>${b.summary || 'n/a'}</td>
              <td class="high-cost">$${Number(b.cost).toFixed(3)}</td>
              <td>${getStatusBadge(b.status)}</td>
            </tr>
          `).join('');
        }

        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

      } catch (e) {
        console.error('Failed to load metrics:', e);
        document.getElementById('costTableBody').innerHTML = 
          `<tr><td colspan="7" class="error">Error loading data: ${e.message}</td></tr>`;
      }
    }

    // Initial load
    loadMetrics();
    
    // Auto-refresh every 30 seconds
    setInterval(loadMetrics, 30000);
  </script>
</body>
</html>
