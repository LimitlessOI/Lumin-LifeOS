<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LifeOS Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f5f5f5;
      background: #050816;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .shell {
      max-width: 1100px;
      margin: 24px auto;
      padding: 20px 24px 32px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(22px);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title {
      font-size: 1.4rem;
      font-weight: 650;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      font-size: 0.75rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #bbf7d0;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.2);
    }
    .status-dot.online {
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 18px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }
    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #e5e7eb;
    }
    .tab.active {
      color: #38bdf8;
      border-bottom-color: #38bdf8;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .conversation-history {
      background: radial-gradient(circle at top left, rgba(51, 65, 85, 0.45), rgba(15, 23, 42, 0.95));
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      margin-bottom: 18px;
      max-height: 300px;
      overflow-y: auto;
    }
    .task-queue {
      background: radial-gradient(circle at top left, rgba(51, 65, 85, 0.45), rgba(15, 23, 42, 0.95));
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      margin-bottom: 18px;
      max-height: 400px;
      overflow-y: auto;
    }
    .task-item {
      padding: 12px;
      margin-bottom: 10px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      border-left: 3px solid #38bdf8;
      cursor: pointer;
      transition: all 0.2s;
    }
    .task-item:hover {
      background: rgba(15, 23, 42, 0.8);
      border-left-color: #22c55e;
    }
    .task-item.active {
      border-left-color: #22c55e;
      background: rgba(15, 23, 42, 0.9);
    }
    .task-item.running {
      border-left-color: #f97316;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    .task-title {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.9rem;
      flex: 1;
    }
    .task-status {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(75, 85, 99, 0.5);
      color: #9ca3af;
    }
    .task-status.running {
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
    }
    .task-status.pending {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(75, 85, 99, 0.3);
      border-radius: 999px;
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transition: width 0.3s;
    }
    .task-eta {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .task-details {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(51, 65, 85, 0.5);
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .task-details.active {
      display: block;
    }
    .task-details-item {
      margin-bottom: 6px;
    }
    .task-details-item strong {
      color: #e5e7eb;
    }
    .conversation-history h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin: 0 0 10px;
    }
    .conversation-item {
      padding: 8px;
      margin-bottom: 8px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      border-left: 3px solid #38bdf8;
      font-size: 0.8rem;
    }
    .conversation-item .user-msg {
      color: #e5e7eb;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .conversation-item .ai-msg {
      color: #9ca3af;
      font-size: 0.75rem;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-item .timestamp {
      color: #6b7280;
      font-size: 0.7rem;
      margin-top: 4px;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 18px;
      margin-top: 12px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: radial-gradient(circle at top left, rgba(51, 65, 85, 0.45), rgba(15, 23, 42, 0.95));
      border-radius: 16px;
      padding: 14px 14px 16px;
      border: 1px solid rgba(51, 65, 85, 0.9);
    }
    .card h2 {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin: 0 0 6px;
    }
    .card small {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 8px;
    }
    label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
      display: inline-block;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      padding: 7px 9px;
      font-size: 0.9rem;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      outline: none;
      box-sizing: border-box;
    }
    textarea {
      min-height: 140px;
      resize: vertical;
      line-height: 1.35;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 0;
      min-width: 120px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 0.9rem;
      font-weight: 550;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #0b1120;
      margin-top: 8px;
    }
    button.secondary {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
    }
    pre {
      margin: 4px 0 0;
      padding: 8px 9px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 0.8rem;
      overflow: auto;
      max-height: 260px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .pill-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .pill {
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 3px 8px;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .pill strong {
      color: #e5e7eb;
    }
    .footer {
      margin-top: 10px;
      font-size: 0.72rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title">
        LifeOS Command Center
        <span class="badge">v26.0 ¬∑ Consensus Online</span>
      </div>
      <div class="status-chip" id="statusChip">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Checking health‚Ä¶</span>
      </div>
    </div>

    <div class="row" style="margin-bottom: 8px;">
      <div>
        <label for="cmdKey">Command Key (x-command-key)</label>
        <input id="cmdKey" type="text" autocomplete="off" placeholder="Paste your COMMAND_CENTER_KEY here‚Ä¶" />
      </div>
      <div>
        <label for="apiBase">API Base</label>
        <input
          id="apiBase"
          type="text"
          autocomplete="off"
          placeholder="https://robust-magic-production.up.railway.app"
        />
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab active" data-tab="queue">üìã Task Queue</button>
      <button class="tab" data-tab="history">üìú Conversation History</button>
    </div>

    <!-- TAB CONTENT: TASK QUEUE -->
    <div class="tab-content active" id="queueTab">
      <div class="task-queue">
        <h3 style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.14em; color: #9ca3af; margin: 0 0 10px;">üöÄ Active Projects & Queue</h3>
        <div id="taskQueueList">Loading task queue...</div>
      </div>
    </div>

    <!-- TAB CONTENT: CONVERSATION HISTORY -->
    <div class="tab-content" id="historyTab">
      <div class="conversation-history">
        <h3>üìú Conversation History</h3>
        <div id="historyList">Loading conversation history...</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Prompt / Council chat -->
      <div class="card">
        <h2>COUNCIL CONSOLE</h2>
        <small>Send a message directly into the AI Council via <code>/api/v1/chat</code>.</small>

        <label for="member">Council Member</label>
        <div class="row">
          <div>
            <select id="member">
              <option value="chatgpt">ChatGPT ‚Äì Primary Executor</option>
              <option value="claude">Claude ‚Äì Strategy (may be offline)</option>
              <option value="gemini">Gemini ‚Äì Research / Ideas</option>
              <option value="deepseek">DeepSeek ‚Äì Infra / Sandbox</option>
              <option value="grok">Grok ‚Äì Reality Check</option>
            </select>
          </div>
        </div>

        <label for="prompt" style="margin-top: 8px;">Message</label>
        <textarea id="prompt" placeholder="Ask the system to do something: 'Outline the next 3 money-making tasks for today‚Ä¶'"></textarea>

        <div class="row">
          <button id="sendBtn">
            ‚û§ Send to Council
          </button>
          <button id="clearBtn" class="secondary">
            ‚å´ Clear
          </button>
        </div>
      </div>

      <!-- RIGHT: Output / Health -->
      <div class="card">
        <h2>OUTPUT & HEALTH</h2>
        <small>Responses, errors, and live health pulled from <code>/healthz</code>.</small>

        <div class="pill-row" id="healthPills"></div>

        <label style="margin-top: 10px;">Latest Response</label>
        <pre id="responseBox">Waiting for first response‚Ä¶</pre>
      </div>
    </div>

    <div class="footer">
      <div>Tip: your browser never needs the API keys directly ‚Äî only the <code>COMMAND_CENTER_KEY</code> gate.</div>
      <div id="metaInfo"></div>
    </div>
  </div>

  <script>
    // HTML escape function for XSS protection
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const healthPills = document.getElementById("healthPills");
    const responseBox = document.getElementById("responseBox");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const promptEl = document.getElementById("prompt");
    const memberEl = document.getElementById("member");
    const cmdKeyEl = document.getElementById("cmdKey");
    const apiBaseEl = document.getElementById("apiBase");
    const metaInfo = document.getElementById("metaInfo");

    // Defensive checks for required elements
    if (!statusDot || !statusText || !healthPills || !responseBox || !sendBtn || !promptEl || !memberEl || !cmdKeyEl || !apiBaseEl || !metaInfo) {
      console.error('Missing required DOM elements');
    }

    // Load saved config
    (function initConfig() {
      const savedKey = localStorage.getItem("lifeos_cmd_key");
      const savedBase = localStorage.getItem("lifeos_api_base");
      if (savedKey) cmdKeyEl.value = savedKey;
      if (savedBase) {
        apiBaseEl.value = savedBase;
      } else {
        apiBaseEl.value = window.location.origin;
      }
    })();

    function saveConfig() {
      localStorage.setItem("lifeos_cmd_key", cmdKeyEl.value.trim());
      localStorage.setItem("lifeos_api_base", apiBaseEl.value.trim());
    }

    cmdKeyEl.addEventListener("change", saveConfig);
    apiBaseEl.addEventListener("change", saveConfig);

    function getBase() {
      const val = apiBaseEl.value.trim() || window.location.origin;
      return val.replace(/\/+$/, "");
    }

    function getKey() {
      return cmdKeyEl.value.trim() || new URLSearchParams(window.location.search).get("key") || "";
    }

    // Load conversation history
    async function loadConversationHistory() {
      const historyList = document.getElementById("historyList");
      if (!historyList) return;
      
      try {
        const key = getKey();
        if (!key) {
          historyList.innerHTML = "<div style='color: #6b7280; font-size: 0.8rem;'>Enter command key to view history</div>";
          return;
        }

        const base = getBase();
        if (!base) {
          historyList.innerHTML = "<div style='color: #ef4444; font-size: 0.8rem;'>Error: Base URL not set</div>";
          return;
        }

        const res = await fetch(`${base}/api/v1/conversations/history?limit=10`, {
          headers: { "x-command-key": key },
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText.slice(0, 100)}`);
        }
        
        const data = await res.json();
        
        if (data.conversations && data.conversations.length > 0) {
          historyList.innerHTML = data.conversations.map(conv => {
            const userMsg = (conv.orchestrator_msg || '').substring(0, 100);
            const userMsgFull = (conv.orchestrator_msg || '').length > 100 ? userMsg + '...' : userMsg;
            const aiMsg = (conv.ai_response || '').substring(0, 150);
            const aiMsgFull = (conv.ai_response || '').length > 150 ? aiMsg + '...' : aiMsg;
            const timestamp = conv.created_at ? new Date(conv.created_at).toLocaleString() : 'Unknown';
            const aiMember = conv.ai_member || 'unknown';
            return `<div class="conversation-item"><div class="user-msg">${escapeHtml(userMsgFull)}</div><div class="ai-msg">${escapeHtml(aiMsgFull)}</div><div class="timestamp">${escapeHtml(timestamp)} ¬∑ ${escapeHtml(aiMember)}</div></div>`;
          }).join('');
        } else {
          historyList.innerHTML = "<div style='color: #6b7280; font-size: 0.8rem;'>No conversations yet</div>";
        }
      } catch (error) {
        const errorMsg = escapeHtml(error.message || String(error));
        historyList.innerHTML = `<div style='color: #ef4444; font-size: 0.8rem;'>Error loading history: ${errorMsg}</div>`;
      }
    }

    // Load history on page load and refresh every 30 seconds
    loadConversationHistory();
    setInterval(loadConversationHistory, 30000);

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // Load data for active tab
        if (tabName === 'queue') {
          loadTaskQueue();
        } else if (tabName === 'history') {
          loadConversationHistory();
        }
      });
    });

    // Load task queue
    async function loadTaskQueue() {
      const taskQueueList = document.getElementById("taskQueueList");
      try {
        const key = getKey();
        if (!key) {
          taskQueueList.innerHTML = "<div style='color: #6b7280; font-size: 0.8rem;'>Enter command key to view queue</div>";
          return;
        }

        const res = await fetch(`${getBase()}/api/v1/tasks/queue`, {
          headers: { "x-command-key": key },
        });
        
        if (!res.ok) throw new Error("Failed to load task queue");
        
        const data = await res.json();
        
        if (data.tasks && data.tasks.length > 0) {
          taskQueueList.innerHTML = data.tasks.map((task, index) => {
            const isActive = task.status === 'running';
            const isExpanded = false; // Will be managed by click handler
            
            return `
              <div class="task-item ${isActive ? 'running' : ''}" data-task-id="${task.id}" data-index="${index}">
                <div class="task-header">
                  <div class="task-title">${task.title || task.description || 'Task'}</div>
                  <div class="task-status ${task.status}">${task.status}</div>
                </div>
                ${isActive ? `
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${task.progress || 0}%"></div>
                  </div>
                  <div class="task-eta">Progress: ${task.progress || 0}%</div>
                ` : `
                  <div class="task-eta">‚è±Ô∏è ETA: ${task.eta || 'Calculating...'}</div>
                `}
                <div class="task-details" id="details-${task.id}">
                  <div class="task-details-item"><strong>Type:</strong> ${task.type || 'N/A'}</div>
                  <div class="task-details-item"><strong>Status:</strong> ${task.status}</div>
                  <div class="task-details-item"><strong>Created:</strong> ${new Date(task.createdAt).toLocaleString()}</div>
                  <div class="task-details-item"><strong>Description:</strong> ${task.description || task.title || 'No description'}</div>
                  ${task.progress !== undefined ? `<div class="task-details-item"><strong>Progress:</strong> ${task.progress}%</div>` : ''}
                  ${task.eta ? `<div class="task-details-item"><strong>ETA:</strong> ${task.eta}</div>` : ''}
                </div>
              </div>
            `;
          }).join('');
          
          // Add click handlers for task details
          document.querySelectorAll('.task-item').forEach(item => {
            item.addEventListener('click', () => {
              const taskId = item.dataset.taskId;
              const details = document.getElementById(`details-${taskId}`);
              
              // Toggle details
              if (details.classList.contains('active')) {
                details.classList.remove('active');
                item.classList.remove('active');
              } else {
                // Close all other details
                document.querySelectorAll('.task-details').forEach(d => d.classList.remove('active'));
                document.querySelectorAll('.task-item').forEach(i => i.classList.remove('active'));
                
                // Open this one
                details.classList.add('active');
                item.classList.add('active');
              }
            });
          });
        } else {
          taskQueueList.innerHTML = "<div style='color: #6b7280; font-size: 0.8rem;'>No tasks in queue</div>";
        }
      } catch (error) {
        taskQueueList.innerHTML = `<div style='color: #ef4444; font-size: 0.8rem;'>Error loading queue: ${error.message}</div>`;
      }
    }

    // Load task queue on page load and refresh every 10 seconds
    loadTaskQueue();
    setInterval(loadTaskQueue, 10000);

    async function checkHealth() {
      try {
        const res = await fetch(getBase() + "/healthz", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        statusDot.classList.add("online");
        statusText.textContent = "Online ¬∑ " + (data.version || "unknown");

        healthPills.innerHTML = "";
        const pill = (label, value) => {
          const el = document.createElement("div");
          el.className = "pill";
          el.innerHTML = "<strong>" + label + ":</strong> " + value;
          healthPills.appendChild(el);
        };

        pill("Spend", `${(data.daily_spend || 0).toFixed(3)} / ${data.max_daily_spend}`);
        pill("ROI", (data.roi && data.roi.roi_ratio ? data.roi.roi_ratio.toFixed(2) : "0") + "x");
        pill("Drones", data.drones ? data.drones.active : 0);
        pill("Tasks done", data.tasks ? data.tasks.completed : 0);
        pill("Ideas (24h)", data.daily_ideas ?? "?");

        metaInfo.textContent =
          "Snapshots: " +
          (data.snapshots_available ?? "?") +
          " ¬∑ Primary AI: " +
          (data.ai_rotation && data.ai_rotation.primary);
      } catch (err) {
        console.error("Health error", err);
        statusDot.classList.remove("online");
        statusText.textContent = "Offline / health error";
        healthPills.innerHTML = "";
      }
    }

    async function sendToCouncil() {
      const text = promptEl.value.trim();
      if (!text) {
        alert("Type a message first.");
        return;
      }
      const key = cmdKeyEl.value.trim();
      if (!key) {
        alert("Paste your COMMAND_CENTER_KEY (x-command-key).");
        return;
      }

      saveConfig();

      sendBtn.disabled = true;
      responseBox.textContent = "Sending‚Ä¶";

      try {
        const res = await fetch(getBase() + "/api/v1/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-command-key": key
          },
          body: JSON.stringify({
            message: text,
            member: memberEl.value,
            autoImplement: true
          })
        });

        const bodyText = await res.text();
        let json;
        try {
          json = JSON.parse(bodyText);
        } catch {
          json = { raw: bodyText };
        }

        if (!res.ok) {
          responseBox.textContent =
            "Error " +
            res.status +
            ":\n" +
            (json.error || JSON.stringify(json, null, 2));
        } else {
          let responseText = json.response || json.message || JSON.stringify(json, null, 2);
          
          // Show implementation status if applicable
          if (json.implementationStarted) {
            responseText = "üöÄ IMPLEMENTATION STARTED!\n\n" + responseText;
          }
          
          responseBox.textContent = responseText;
          
          // Reload conversation history after sending message
          setTimeout(loadConversationHistory, 1000);
        }
      } catch (err) {
        console.error(err);
        responseBox.textContent = "Network / JS error:\n" + err.message;
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendToCouncil);
    clearBtn.addEventListener("click", () => {
      promptEl.value = "";
      responseBox.textContent = "Cleared. Ready for next command.";
    });

    // Enter + Cmd/Ctrl+Enter shortcuts
    promptEl.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
        e.preventDefault();
        sendToCouncil();
      }
    });

    checkHealth();
    setInterval(checkHealth, 60000);
  </script>
</body>
</html>
