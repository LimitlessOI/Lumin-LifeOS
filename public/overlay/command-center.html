<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS Universal Overlay</title>
    <link rel="stylesheet" href="command-center.css">
</head>
<body>
    <!-- Universal Overlay Container -->
    <div id="lifeos-overlay" class="overlay-container">
        <!-- Header with App Switcher -->
        <div class="overlay-header">
            <div class="app-switcher">
                <select id="app-selector">
                    <option value="command-center">ğŸš€ Command Center</option>
                    <option value="architect">ğŸ—ï¸ Architect</option>
                    <option value="grammarly">âœï¸ Writing Assistant</option>
                    <option value="social">ğŸ“± Social Media</option>
                    <option value="games">ğŸ® Games</option>
                    <option value="custom">âš™ï¸ Custom App</option>
                </select>
            </div>
            <div class="controls">
                <button id="toggle-voice" class="control-btn">ğŸ¤ Voice</button>
                <button id="toggle-pin" class="control-btn">ğŸ“Œ Pin</button>
                <button id="council-meeting" class="control-btn">ğŸ‘¥ Council</button>
                <button id="minimize" class="control-btn">âˆ’</button>
            </div>
        </div>

        <!-- Main Content Area - Dynamic based on selected app -->
        <div class="main-content" id="main-content">
            <!-- Command Center App (Default) -->
            <div class="app-content" id="app-command-center">
                <!-- Project Tracker -->
                <div class="project-tracker">
                    <h4>ğŸ“Š Active Projects</h4>
                    <div id="project-list">
                        <div class="project-item">
                            <div class="project-header">
                                <span class="project-title">Universal Overlay System</span>
                                <span class="project-progress">75%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                            <div class="project-details" style="display: none;">
                                <div class="detail-item">âœ… Multi-app Foundation</div>
                                <div class="detail-item">âœ… Draggable & Resizable</div>
                                <div class="detail-item">âœ… White Theme</div>
                                <div class="detail-item">ğŸ”„ App Switching System</div>
                                <div class="detail-item">â³ Voice Integration</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Council Chat -->
                <div class="council-chat">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message ai-message">
                            <div class="message-header">
                                <span class="ai-name claude">Claude</span>
                                <span class="message-time">Just now</span>
                            </div>
                            <div class="message-content">
                                Welcome to the Universal LifeOS Overlay! This is your foundation for all apps - Command Center, Architect, writing tools, games, and more. Everything runs in this single overlay system.
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <textarea id="text-input" placeholder="Ask your AI council or give commands..."></textarea>
                        <div class="input-buttons">
                            <button id="voice-input" class="voice-btn">ğŸ¤</button>
                            <button id="send-message" class="send-btn">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn" data-action="upload-file">ğŸ“ Upload File</button>
                    <button class="action-btn" data-action="request-ideas">ğŸ’¡ Get 25 Ideas</button>
                    <button class="action-btn" data-action="analyze-decision">âš–ï¸ Dual Analysis</button>
                    <button class="action-btn" data-action="performance-review">ğŸ“Š Performance</button>
                </div>
            </div>

            <!-- Architect App -->
            <div class="app-content" id="app-architect" style="display: none;">
                <div class="architect-panel">
                    <h4>ğŸ—ï¸ Architect Mode</h4>
                    <div class="micro-controls">
                        <div class="mode-toggle">
                            <button class="mode-btn active" data-mode="chat">ğŸ’¬ Chat</button>
                            <button class="mode-btn" data-mode="command">âš¡ Command</button>
                            <button class="mode-btn" data-mode="team">ğŸ‘¥ Team</button>
                        </div>
                        <div class="micro-stats">
                            <span class="stat">MICRO: 73% savings</span>
                            <span class="stat">STT: Ready</span>
                            <span class="stat">TTS: Ready</span>
                        </div>
                    </div>
                    <div class="architect-output" id="architect-output">
                        <p>Architect mode loaded. Ready for MICRO protocol conversations.</p>
                    </div>
                </div>
            </div>

            <!-- Writing Assistant App -->
            <div class="app-content" id="app-grammarly" style="display: none;">
                <div class="writing-panel">
                    <h4>âœï¸ Writing Assistant</h4>
                    <textarea class="writing-input" placeholder="Paste your text here for AI analysis..."></textarea>
                    <div class="writing-controls">
                        <button class="writing-btn" data-action="grammar-check">Grammar Check</button>
                        <button class="writing-btn" data-action="improve-style">Improve Style</button>
                        <button class="writing-btn" data-action="summarize">Summarize</button>
                    </div>
                    <div class="writing-output" id="writing-output"></div>
                </div>
            </div>
        </div>

        <!-- Hidden File Input -->
        <input type="file" id="file-upload" style="display: none;" multiple>
    </div>

    <!-- IMPORTANT: MICRO protocol must load before command-center.js -->
    <script src="MicroProtocol.js"></script>
    <script src="command-center.js"></script>

    <!-- Inline wiring: chat + self-program -->
    <script>
        // Must match COMMAND_CENTER_KEY in server.js
        const LIFEOS_API_KEY = 'MySecretKey2025LifeOS';
        const LIFEOS_BASE_URL = window.location.origin;

        const chatMessagesEl = document.getElementById('chat-messages');
        const textInputEl = document.getElementById('text-input');
        const sendBtnEl = document.getElementById('send-message');

        function addMessageBubble(role, text, meta = {}) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message ' + (role === 'user' ? 'user-message' : 'ai-message');

            const header = document.createElement('div');
            header.className = 'message-header';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'ai-name ' + (meta.member || '');
            nameSpan.textContent = role === 'user' ? 'You' : (meta.member || 'Council');

            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString();

            header.appendChild(nameSpan);
            header.appendChild(timeSpan);

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            wrapper.appendChild(header);
            wrapper.appendChild(content);

            chatMessagesEl.appendChild(wrapper);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        async function sendChatMessage() {
            const text = (textInputEl.value || '').trim();
            if (!text) return;

            addMessageBubble('user', text);
            textInputEl.value = '';

            try {
                // Special command: !self <instruction>  â†’  self-programming API
                if (text.startsWith('!self ')) {
                    const instruction = text.slice('!self '.length).trim();

                    const res = await fetch(
                        `${LIFEOS_BASE_URL}/api/v1/system/self-program?key=${encodeURIComponent(LIFEOS_API_KEY)}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instruction, priority: 'medium' })
                        }
                    );

                    const data = await res.json();

                    if (!data || data.ok === false) {
                        addMessageBubble(
                            'assistant',
                            `Self-program error: ${(data && data.error) || 'Unknown error'}`,
                            { member: 'self-program' }
                        );
                        return;
                    }

                    const modified = (data.filesModified || []).join(', ') || 'none';
                    const summaryLines = [
                        'Self-program request accepted.',
                        `Files modified: ${modified}`,
                        `Deployment: ${data.deploymentTriggered ? 'triggered' : 'not triggered'}`,
                        `Blind spots detected: ${data.blindSpotsDetected || 0}`
                    ];

                    addMessageBubble(
                        'assistant',
                        summaryLines.join('\n'),
                        { member: 'self-program' }
                    );
                    return;
                }

                // Normal chat â†’ /api/v1/chat
                const res = await fetch(
                    `${LIFEOS_BASE_URL}/api/v1/chat?key=${encodeURIComponent(LIFEOS_API_KEY)}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    }
                );

                const data = await res.json();
                if (!data || data.ok === false) {
                    addMessageBubble(
                        'assistant',
                        `Error: ${(data && data.error) || 'Unknown error'}`,
                        {}
                    );
                    return;
                }

                addMessageBubble(
                    'assistant',
                    data.response || '[empty response]',
                    { member: data.member || '' }
                );
            } catch (err) {
                addMessageBubble(
                    'assistant',
                    `Network error: ${err && err.message ? err.message : 'Unknown network error'}`,
                    {}
                );
            }
        }

        // Wire up events
        if (sendBtnEl) {
            sendBtnEl.addEventListener('click', sendChatMessage);
        }

        if (textInputEl) {
            textInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }
    </script>
</body>
</html>
