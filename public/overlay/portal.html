<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LifeOS Architect â€¢ MICRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0a0a0a; --panel:#111; --fg:#e5ffe5; --accent:#00ff6a; --dim:#6b7280;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    html, body { height:100%; }
    body { margin:0; background:transparent; font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; color:var(--fg); }
    /* floating bubble */
    #lifeos-bubble {
      position: fixed; z-index: 2147483647; right: 20px; bottom: 20px;
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--accent); color:#000; display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow); cursor:pointer; user-select:none; font-weight:800;
    }
    /* panel */
    #lifeos-panel {
      position: fixed; z-index: 2147483647; right: 20px; bottom: 84px;
      width: 420px; max-height: 70vh; background: var(--panel); border: 1px solid #1f2937; border-radius: 16px;
      box-shadow: var(--shadow); display:none; overflow:hidden;
    }
    .panel-header {
      display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1f2937;
      background: linear-gradient(180deg, #0f172a 0%, #111827 100%);
    }
    .hdr-left { display:flex; gap:10px; align-items:center; }
    .dot { width:10px; height:10px; border-radius:50%; background: var(--accent); box-shadow:0 0 14px var(--accent); }
    .title { font-weight:700; font-size:14px; }
    .sub { color: var(--dim); font-size:12px; }
    .close { background:transparent; border:0; color:#cbd5e1; font-weight:700; cursor:pointer; }
    .panel-body { display:flex; flex-direction:column; gap:10px; padding:12px; }
    .log {
      background:#0b0b0b; border:1px solid #1f2937; border-radius:12px; padding:10px; height:280px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
    }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="text"] {
      flex:1; background:#0b0b0b; border:1px solid #1f2937; border-radius:10px; padding:10px; color:var(--fg);
    }
    button {
      background: var(--accent); color:#000; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
    }
    button.secondary { background:#1f2937; color:#e5e7eb; border:1px solid #374151; }
    .pill { font-size:11px; color:#a3a3a3; }
    .kv { color:#a3e6ff; }
    .user { color:#a7f3d0; }
    .sys { color:#fef3c7; }
    .err { color:#fecaca; }
  </style>
</head>
<body>
  <div id="lifeos-bubble" title="Open LifeOS Overlay">L</div>

  <div id="lifeos-panel" role="dialog" aria-label="LifeOS Overlay">
    <div class="panel-header">
      <div class="hdr-left">
        <div class="dot"></div>
        <div>
          <div class="title">LifeOS Architect â€¢ MICRO</div>
          <div class="sub" id="hdr-sub">Ready â€¢ press and hold mic, talk in real time</div>
        </div>
      </div>
      <button class="close" id="closeBtn">âœ•</button>
    </div>

    <div class="panel-body">
      <div class="row">
        <span class="pill">Base: <span id="baseShow" class="kv"></span></span>
        <span class="pill">Key: <span id="keyShow" class="kv"></span></span>
      </div>

      <div id="log" class="log" aria-live="polite"></div>

      <div class="row">
        <input id="text" type="text" placeholder="Type here, or hold mic and speakâ€¦" autocomplete="off" />
        <button id="sendBtn">Send</button>
        <button id="micBtn" class="secondary" title="Hold to talk">ðŸŽ¤ Hold</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- UTIL / STATE ----------
    const qs = new URLSearchParams(location.search);
    const BASE = (qs.get('base') || location.origin).replace(/\/+$/, '');
    const KEY  = qs.get('key') || '';
    const dom  = (id) => document.getElementById(id);

    dom('baseShow').textContent = BASE;
    dom('keyShow').textContent  = KEY ? (KEY.length > 6 ? KEY.slice(0,3)+'â€¦'+KEY.slice(-3) : 'set') : 'MISSING';
    const logEl = dom('log');

    function log(line, cls) {
      const div = document.createElement('div');
      div.className = cls || '';
      div.textContent = line;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ---------- MICRO helpers ----------
    function encodeMicro({ operation, description, type, returnFields }) {
      const parts = ['V:2.0'];
      if (operation) parts.push('OP:'+operation.charAt(0).toUpperCase());
      if (description) {
        const c = String(description)
          .replace(/generate/gi,'GEN').replace(/analyze/gi,'ANL').replace(/create/gi,'CRT')
          .replace(/build/gi,'BLD').replace(/optimize/gi,'OPT').replace(/review/gi,'REV')
          .replace(/\s+/g,'~');
        parts.push('D:'+c.slice(0,80));
      }
      if (type) parts.push('T:'+type.charAt(0).toUpperCase());
      if (returnFields && returnFields.length) parts.push('R:~'+returnFields.join('~'));
      return parts.join('|');
    }

    function decodeMicro(micro) {
      const out = {};
      String(micro).split('|').forEach(seg=>{
        const [k,v] = seg.split(':'); if (!v) return;
        if (k==='CT') out.content = v.replace(/~/g,' ');
        if (k==='KP') out.keyPoints = v.split('~').filter(Boolean);
      });
      return out;
    }

    async function sendMicro(microText) {
      if (!KEY) throw new Error('Missing ?key= in URL');
      const url = `${BASE}/api/v1/architect/micro?key=${encodeURIComponent(KEY)}`;
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain'}, body: microText });
      const txt = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0,160)}`);
      return txt;
    }

    // ---------- TTS ----------
    function speak(text) {
      try {
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1.0; utter.pitch = 1.0;
        speechSynthesis.speak(utter);
      } catch (e) { /* non-fatal */ }
    }

    // ---------- STT (real-time, push-to-talk) ----------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening = false;

    function initSR() {
      if (!SR) { log('Real-time speech not supported in this browser.', 'err'); return; }
      rec = new SR();
      rec.lang = 'en-US';
      rec.continuous = true;
      rec.interimResults = true;

      let finalSoFar = '';

      rec.onresult = (e)=>{
        let interim = '';
        for (let i=e.resultIndex; i<e.results.length; i++) {
          const r = e.results[i];
          if (r.isFinal) finalSoFar += r[0].transcript + ' ';
          else interim += r[0].transcript;
        }
        dom('text').value = (finalSoFar + interim).trim();
        dom('hdr-sub').textContent = 'Listeningâ€¦ (releasing mic will send)';
      };
      rec.onerror = (e)=> { log('STT error: '+e.error, 'err'); };
      rec.onend = ()=> { listening = false; dom('hdr-sub').textContent = 'Ready'; };
    }

    // ---------- UI handlers ----------
    dom('lifeos-bubble').onclick = ()=> { dom('lifeos-panel').style.display='block'; };
    dom('closeBtn').onclick = ()=> { dom('lifeos-panel').style.display='none'; };

    dom('sendBtn').onclick = async ()=>{
      const text = dom('text').value.trim();
      if (!text) return;

      // naive intent/type guess
      const lower = text.toLowerCase();
      const op = lower.includes('analy') ? 'analyze'
              : lower.includes('build') ? 'build'
              : lower.includes('optimiz') ? 'optimize'
              : lower.includes('create') || lower.includes('make') ? 'create'
              : 'generate';
      const type = lower.includes('script') ? 'script'
                : lower.includes('report') ? 'report'
                : lower.includes('code') ? 'code'
                : 'general';

      const micro = encodeMicro({ operation: op, description: text, type, returnFields: ['CT','KP'] });
      log('â†’ MICRO OUT: '+micro, 'kv');

      try {
        const reply = await sendMicro(micro);
        log('â† MICRO IN:  '+reply, 'kv');

        const parsed = decodeMicro(reply);
        if (parsed.content) {
          log('AI: '+parsed.content, 'sys');
          speak(parsed.content);
        } else {
          log('AI (raw): '+reply, 'sys');
        }
      } catch (e) {
        log('ERROR: '+e.message, 'err');
      }
    };

    // press & hold mic
    dom('micBtn').addEventListener('mousedown', ()=> {
      if (!rec) initSR();
      if (rec && !listening) { try { rec.start(); listening = true; dom('micBtn').textContent='ðŸŽ¤ Listeningâ€¦'; } catch{} }
    });
    dom('micBtn').addEventListener('mouseup', async ()=> {
      if (rec && listening) { try { rec.stop(); } catch{} }
      dom('micBtn').textContent='ðŸŽ¤ Hold';
      // auto-send whatever is in the box
      dom('sendBtn').click();
    });
    dom('micBtn').addEventListener('mouseleave', ()=> {
      if (rec && listening) { try { rec.stop(); } catch{} }
      dom('micBtn').textContent='ðŸŽ¤ Hold';
    });

    // enter to send
    dom('text').addEventListener('keydown', (e)=> { if (e.key==='Enter') dom('sendBtn').click(); });

    // initial status
    log('Overlay ready. Talk or type, everything goes over MICRO.', 'user');
    if (!KEY) log('Missing ?key= in URL. Append ?key=MySecretKey2025LifeOS', 'err');
  </script>
</body>
</html>
