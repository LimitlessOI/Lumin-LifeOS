<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LifeOS Architect ‚Ä¢ MICRO v1.3</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --card:#1a2130; --muted:#8ea0b5; --text:#e9eef6;
    --accent:#6ee7b7; --accent-2:#60a5fa; --danger:#f87171; --border:#233042;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  .panel{position:fixed;right:24px;bottom:24px;width:860px;height:680px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.02)),var(--panel);
    border:1px solid var(--border);border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.45);display:flex;flex-direction:column;overflow:hidden;resize:both}
  .titlebar{display:flex;align-items:center;gap:10px;padding:12px 14px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border);cursor:move;user-select:none}
  .titlebar h1{margin:0;font-size:15px;letter-spacing:.2px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#111827;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
  .grow{flex:1}
  .btn{background:#1f2937;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{background:linear-gradient(90deg,var(--accent-2),#34d399);border-color:transparent;color:#06121e;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.danger{background:#2a1212;border-color:#3f1a1a;color:#ffb4b4}

  .content{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;padding:14px;height:100%}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;min-height:0}
  .card h2{margin:0 0 8px 0;font-size:13px;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}

  .log{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0c121a;border:1px solid var(--border);border-radius:8px;color:#bfe2ff;
       padding:10px;min-height:64px;max-height:140px;overflow:auto;line-height:1.35}
  .ai{background:#0e131b;border:1px solid var(--border);border-radius:10px;padding:12px;min-height:160px;max-height:275px;overflow:auto;white-space:pre-wrap}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .input{width:100%;min-height:120px;max-height:260px;overflow:auto;resize:vertical;background:#0e131b;color:var(--text);
         border:1px solid var(--border);border-radius:10px;padding:12px;font:14px/1.5 ui-sans-serif,system-ui}
  .switch{display:inline-flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;margin-right:10px}

  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;background:#0e1620;border:1px solid var(--border);border-radius:8px;color:#bfe2ff;font-size:12px}
  .progress{height:8px;border-radius:6px;background:#0e1620;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent-2),#34d399)}
  a.link{color:#90cdf4;text-decoration:none}
  a.link:hover{text-decoration:underline}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal>.box{width:560px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 16px 50px rgba(0,0,0,.55)}
</style>
</head>
<body>

<div class="panel" id="panel" aria-label="LifeOS Portal v1.3">
  <div class="titlebar" id="drag">
    <h1>LifeOS Architect ‚Ä¢ MICRO v1.3</h1>
    <span class="pill">Real-time STT</span><span class="pill">TTS Natural</span><span class="pill">Team Mode</span>
    <div class="grow"></div>
    <button class="btn ghost" id="minBtn" title="Minimize">‚Üò</button>
    <button class="btn ghost" id="closeBtn" title="Close">‚úï</button>
  </div>

  <div class="content" id="content">
    <!-- Left -->
    <div class="card">
      <h2>Conversation</h2>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <input id="base" class="chip" style="flex:1" placeholder="https://robust-magic-production.up.railway.app" />
        <input id="key"  class="chip" style="width:260px" placeholder="COMMAND_CENTER_KEY" />
        <label class="switch"><input type="checkbox" id="team" /> Team</label>
        <button class="btn" id="pingBtn">Ping</button>
        <button class="btn" id="commitBtn">Commit to GitHub</button>
      </div>

      <div class="log" id="microLog">‚Ä¢ Ready. v1.3 loaded.</div>
      <div class="ai" id="aiOut" style="margin-top:10px">Type naturally; I‚Äôll compress to MICRO for you.</div>

      <textarea id="input" class="input" placeholder="Type or paste long commands. Hold mic to talk."></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="sendBtn">Send</button>
        <button class="btn" id="pttBtn">üéôÔ∏è Hold to talk</button>

        <label class="switch"><input type="checkbox" id="enterSends" checked /> Enter sends (Shift+Enter = newline)</label>
        <label class="switch"><input type="checkbox" id="handsfree" /> Hands-free mic</label>
        <input id="hfSecs" type="range" min="10" max="180" step="10" value="120" style="width:140px"><span class="chip" id="hfLabel">120s</span>

        <label class="switch"><input type="checkbox" id="speak" checked /> Speak replies</label>
        <button class="btn danger" id="stopSpeakBtn">Stop</button>
      </div>
    </div>

    <!-- Right -->
    <div class="card">
      <h2>Tasks & Progress</h2>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <div class="chip" id="roiPill">ROI: ‚Äî</div>
        <div class="chip" id="spendPill">Spend: ‚Äî</div>
        <div class="chip" id="queuePill">Queue: ‚Äî</div>
        <div class="grow"></div>
        <button class="btn" id="refreshTasks">Refresh</button>
      </div>
      <div id="tasksList" style="display:flex;flex-direction:column;gap:10px;overflow:auto"></div>
      <div class="row" style="margin-top:auto"><a class="link" href="/overlay/architect.html" target="_blank">Open classic overlay</a></div>
    </div>
  </div>
</div>

<!-- Commit modal -->
<div class="modal" id="commitModal" aria-hidden="true">
  <div class="box">
    <div class="row"><h2 style="margin:0;font-size:16px">Commit to GitHub</h2><div class="grow"></div><button class="btn ghost" id="cmClose">‚úï</button></div>
    <div class="row" style="margin-top:8px"><input class="chip" id="cmPath" placeholder="public/overlay/portal.html" style="flex:1"></div>
    <div class="row" style="margin-top:8px"><input class="chip" id="cmMsg" placeholder="feat: update portal with hands-free + tasks"></div>
    <div class="row" style="margin-top:8px"><textarea class="input" id="cmContent" style="height:220px" placeholder="Paste full file content here"></textarea></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px"><button class="btn primary" id="cmDo">Commit</button></div>
    <div class="log" id="cmLog" style="margin-top:8px"></div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  // Prefill config
  $('base').value = qs.get('base') || location.origin;
  $('key').value  = qs.get('key')  || '';
  $('team').checked = qs.get('team') === '1';
  $('hfLabel').textContent = $('hfSecs').value + 's';

  // Draggable header
  (function makeDraggable(){
    const panel = $('panel'), drag = $('drag');
    let sx=0, sy=0, px=0, py=0, dragging=false;
    drag.addEventListener('mousedown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); px=r.left; py=r.top; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(px+dx)+'px'; panel.style.top=(py+dy)+'px'; panel.style.right='auto'; panel.style.bottom='auto'; });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  })();

  // Minimize/close
  $('closeBtn').onclick = () => { $('panel').style.display='none'; };
  $('minBtn').onclick   = () => { $('panel').style.height='52px'; $('content')?.scrollTo?.(0,0); };
  $('drag').ondblclick  = () => { $('panel').style.height='680px'; };

  // Logging
  function logMicro(prefix, text){
    const el = $('microLog');
    const ts = new Date().toLocaleTimeString();
    el.textContent = (el.textContent + `\n${prefix} ${ts}: ${text}`).slice(-8000);
    el.scrollTop = el.scrollHeight;
  }
  function setAI(text){ $('aiOut').textContent = text; }

  // MICRO helpers
  function toMicro(english){
    const t = english.toLowerCase();
    const op = /generate|create|build/.test(t) ? 'G' : /analyz|report|explain|plan/.test(t) ? 'A' : 'G';
    const type = /script/.test(t) ? 'S' : /report|plan|doc/.test(t) ? 'R' : 'G';
    const d = english
      .replace(/generate/gi,'GEN').replace(/analyz/gi,'ANL').replace(/create/gi,'CRT').replace(/build/gi,'BLD')
      .trim().replace(/\s+/g,'~').slice(0,240);
    return `V:2.0|OP:${op}|D:${d}|T:${type}|R:~CT~KP`;
  }
  function fromMicro(resp){
    const part = resp.split('|').find(p=>p.startsWith('CT:'));
    return part ? part.slice(3).replace(/~/g,' ') : resp;
  }

  // Send
  async function send(){
    const text = $('input').value.trim();
    if(!text) return;
    $('input').value='';
    const micro = toMicro(text);
    logMicro('‚Üí MICRO OUT', micro);
    try{
      const base = $('base').value.replace(/\/+$/,'');
      const key = $('key').value;
      const team = $('team').checked ? '&team=1' : '';
      const t0 = performance.now();
      const r = await fetch(`${base}/api/v1/architect/micro?key=${encodeURIComponent(key)}${team}`,{
        method:'POST', headers:{'Content-Type':'text/plain'}, body: micro
      });
      const body = await r.text();
      logMicro('‚Üê MICRO IN', body);
      const english = fromMicro(body);
      const dt = Math.round(performance.now()-t0);
      setAI(english + `\n\n(${dt} ms)`);
      speak(english);
    }catch(e){ setAI('Error: '+e.message); }
  }
  $('sendBtn').onclick = send;
  $('input').addEventListener('keydown',(e)=>{
    if ($('enterSends').checked && e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('sendBtn').click(); }
  });

  // Ping
  $('pingBtn').onclick = async ()=>{
    try{
      const base=$('base').value.replace(/\/+$/,''); const key=$('key').value;
      const t0=performance.now(); const r=await fetch(`${base}/healthz?key=${encodeURIComponent(key)}`);
      const dt=Math.round(performance.now()-t0); const j=await r.json();
      setAI(`Server OK (${dt} ms)\nTasks: queued ${j.queued_tasks}, in-progress ${j.active_tasks}\nSpend: ${j.spend_percentage}`);
    }catch(e){ setAI('Ping failed: '+e.message); }
  };

  // Commit modal
  $('commitBtn').onclick = ()=>{ $('commitModal').style.display='flex'; $('cmPath').value='public/overlay/portal.html'; $('cmMsg').value='feat: update portal v1.3'; $('cmContent').value=''; $('cmLog').textContent=''; };
  $('cmClose').onclick = ()=>{ $('commitModal').style.display='none'; };
  $('cmDo').onclick = async ()=>{
    const base=$('base').value.replace(/\/+$/,''); const key=$('key').value;
    const path=$('cmPath').value.trim(); const message=$('cmMsg').value.trim(); const content=$('cmContent').value;
    if(!path || !content){ $('cmLog').textContent='Path and content required.'; return; }
    try{
      const r = await fetch(`${base}/api/v1/dev/commit?key=${encodeURIComponent(key)}`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path, content, message })
      });
      const j = await r.json();
      $('cmLog').textContent = j.ok ? `‚úÖ Committed ${j.committed} (${j.sha||'sha'})` : `‚ùå ${j.error||'Commit failed'}`;
    }catch(e){ $('cmLog').textContent = '‚ùå '+e.message; }
  };

  // STT (push-to-talk + hands-free)
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null, hfTimer=null;
  function startRec(){
    if(!SR){ alert('Web Speech API not supported'); return; }
    if(rec){ try{rec.stop();}catch{} rec=null; }
    rec = new SR(); rec.interimResults=true; rec.continuous=true; rec.lang='en-US';
    let final=''; rec.onresult=(e)=>{ let interim=''; for(let i=e.resultIndex;i<e.results.length;i++){ const tr=e.results[i][0].transcript; if(e.results[i].isFinal) final+=tr+' '; else interim+=tr; } $('input').value=(final+interim).trim(); };
    rec.onend=()=>{ if($('handsfree').checked){ rec.start(); } else { $('pttBtn').textContent='üéôÔ∏è Hold to talk'; $('pttBtn').classList.remove('primary'); } };
    rec.start(); $('pttBtn').textContent='üéôÔ∏è Listening‚Ä¶'; $('pttBtn').classList.add('primary');
  }
  function stopRec(){ if(rec){ try{rec.stop();}catch{} rec=null; $('pttBtn').textContent='üéôÔ∏è Hold to talk'; $('pttBtn').classList.remove('primary'); } }
  $('pttBtn').addEventListener('mousedown', startRec);
  $('pttBtn').addEventListener('touchstart', startRec, {passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>$('pttBtn').addEventListener(ev, stopRec));

  $('handsfree').addEventListener('change', ()=>{
    clearTimeout(hfTimer);
    if($('handsfree').checked){ startRec(); hfTimer=setTimeout(()=>{ $('handsfree').checked=false; stopRec(); }, Number($('hfSecs').value)*1000); }
    else{ stopRec(); }
  });
  $('hfSecs').oninput = ()=>{ $('hfLabel').textContent = $('hfSecs').value + 's'; if($('handsfree').checked){ $('handsfree').dispatchEvent(new Event('change')); } };

  // TTS
  let cachedVoice=null;
  function chooseVoice(){
    const voices = speechSynthesis.getVoices();
    return voices.find(v=>/(Natural|Neural|Google US English|UK English Female)/i.test(v.name)) || voices.find(v=>/en/i.test(v.lang)) || null;
  }
  if('speechSynthesis' in window){
    cachedVoice = chooseVoice();
    window.speechSynthesis.onvoiceschanged = ()=>{ cachedVoice = chooseVoice(); };
  }
  function speak(text){
    if(!$('speak').checked) return;
    if(!('speechSynthesis' in window)) return;
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      if(cachedVoice) u.voice = cachedVoice;
      u.rate = 0.95; u.pitch = 1.0;
      speechSynthesis.speak(u);
    }catch{}
  }
  $('stopSpeakBtn').onclick = ()=>{ try{speechSynthesis.cancel();}catch{} };

  // Tasks & ROI (live)
  async function refreshRight(){
    try{
      const base=$('base').value.replace(/\/+$/,''); const key=$('key').value;
      const [tRes, roiRes] = await Promise.all([
        fetch(`${base}/api/v1/tasks?key=${encodeURIComponent(key)}`),
        fetch(`${base}/api/v1/roi/status?key=${encodeURIComponent(key)}`)
      ]);
      const t = await tRes.json(); const roi = await roiRes.json();

      const list = (t.tasks || []).slice().reverse();
      $('queuePill').textContent = `Queue: ${list.length}`;
      if (roi.ok){
        const r = roi.roi || {};
        const ratio = (typeof r.roi_ratio === 'number') ? r.roi_ratio.toFixed(2)+'x' : (r.ratio || '‚Äî');
        $('roiPill').textContent = `ROI: ${ratio}`;
        const spend = r.daily_spend ?? 0;
        $('spendPill').textContent = `Spend: $${Number(spend).toFixed(2)}`;
      }

      $('tasksList').innerHTML = list.map(task=>{
        const pct = task.status==='complete'? 100 : task.status==='in-progress'? 50 : 0;
        const prio = (task.priority || 'low').toLowerCase();
        const prioClr = prio==='high' ? '#ef4444' : prio==='med' ? '#f59e0b' : '#10b981';
        const saved = (task.result && typeof task.result.compression_pct!=='undefined') ? `${task.result.compression_pct}%` : '‚Äî';
        const summary = (task.result && task.result.summary) ? task.result.summary : '';
        return `
          <div class="card" style="padding:10px">
            <div class="row" style="justify-content:space-between">
              <div><strong>#${task.id}</strong> ‚Ä¢ ${task.description}</div>
              <div style="color:${pct===100?'#22c55e':pct===50?'#60a5fa':'#8ea0b5'}">${task.status} (${pct}%)</div>
            </div>
            <div class="row" style="gap:8px;margin-top:6px">
              <span class="chip" style="border-color:${prioClr};color:${prioClr}">prio: ${prio}</span>
              <span class="chip">Saved: ${saved}</span>
              ${task.estimated_revenue ? `<span class="chip">Rev: $${Number(task.estimated_revenue).toFixed(0)}</span>`:''}
            </div>
            <div class="progress" style="margin-top:8px"><span style="width:${pct}%"></span></div>
            ${summary ? `<div style="margin-top:6px;color:#a6c5d6;font-size:12px">${summary}</div>`:''}
          </div>`;
      }).join('');
    }catch(e){
      // silent
    }
  }
  $('refreshTasks').onclick = refreshRight;
  setInterval(refreshRight, 2500);
  refreshRight();

  // Auto-send via ?q=
  if (qs.get('q')) { $('input').value = qs.get('q'); $('sendBtn').click(); }
})();
</script>
</body>
</html>
