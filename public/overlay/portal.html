<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>LifeOS Architect â€¢ MICRO v1.2</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
Â  :root{
Â  Â  --bg:#0b0f14; --panel:#0f151c; --panel2:#111923; --fg:#e6edf3; --muted:#8aa1b2;
Â  Â  --accent:#22c55e; --accent2:#38bdf8; --danger:#ef4444; --border:#1f2a37;
Â  }
Â  html,body{height:100%; margin:0; background:transparent; font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto; color:var(--fg);}
Â  /* container */
Â  #portal{
Â  Â  position:fixed; right:24px; bottom:24px; width:720px; height:560px; display:flex; flex-direction:column;
Â  Â  background:linear-gradient(180deg, rgba(17,25,35,.96), rgba(12,17,24,.96)); border:1px solid var(--border);
Â  Â  border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.45); overflow:hidden; backdrop-filter:saturate(1.2) blur(8px);
Â  Â  resize:both; /* resizable corner - drag lower-right */
Â  }
Â  #hdr{display:flex; align-items:center; gap:10px; padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--border);}
Â  #title{font-weight:700;}
Â .tag{font-size:12px; color:#cfe7ff; background:#0b2738; border:1px solid #183144; padding:4px 8px; border-radius:999px;}
Â .sp{flex:1}
Â .btn{background:#15202b; border:1px solid var(--border); color:var(--fg); padding:8px 12px; border-radius:10px; cursor:pointer}
Â .btn:hover{background:#192634}
Â .btn.acc{background:#16301f; border-color:#1d3f2a}
Â .btn.acc:hover{background:#173723}
Â .btn.red{background:#2a1414; border-color:#452020}
Â .row{display:flex; gap:8px; align-items:center}
Â  input, textarea{background:#0e1620; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
Â  input[type=range]{height:6px; background:#162433; border-radius:3px}
Â  input::placeholder, textarea::placeholder{color:var(--muted)}
Â  #conf{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border); background:var(--panel2)}
Â  #conf input{height:36px}
Â  #teamToggle{display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer;}
Â  #teamToggle input{width:16px; height:16px}
Â  /* layout: messages + side panel */
Â  #main{display:grid; grid-template-columns:1fr 320px; gap:0; height:100%}
Â  #left{display:flex; flex-direction:column; height:100%}
Â  #io{padding:10px; display:flex; flex-direction:column; gap:8px; overflow:auto}
Â .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; background:#0a121a; border:1px dashed #1d2b39; border-radius:8px; padding:10px; color:#bde0ff}
Â  #chat{display:flex; flex-direction:column; gap:10px; padding:10px; overflow:auto}
Â .bubble{background:#0e1620; border:1px solid var(--border); border-radius:12px; padding:12px}
Â .bubble h5{margin:0 0 6px 0; font-size:12px; color:var(--muted)}
Â  /* input area */
Â  #inpWrap{padding:10px; border-top:1px solid var(--border); background:var(--panel2); display:flex; gap:8px; align-items:flex-end}
Â  #msg{flex:1; min-height:56px; max-height:200px; overflow:auto; resize:vertical}
Â  #inpCtrls{display:flex; flex-direction:column; gap:6px}
Â .switch{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
Â  /* side panel */
Â  #right{border-left:1px solid var(--border); background:#0b1118; display:flex; flex-direction:column}
Â  #kpi{display:flex; gap:6px; flex-wrap:wrap; padding:10px; border-bottom:1px solid var(--border); background:#0f161f}
Â .pill{font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:#0e1620}
Â  #tasks{padding:10px; overflow:auto; display:flex; flex-direction:column; gap:8px}
Â .task{border:1px solid var(--border); border-radius:10px; background:#0e1620; padding:10px}
Â .task.trow{display:flex; justify-content:space-between; gap:8px}
Â .prio-badge{padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600}
Â .prio-high{background:#ef4444; color:white}
Â .prio-med{background:#f59e0b; color:white}
Â .prio-low{background:#10b981; color:white}
Â .bar{height:8px; border-radius:999px; background:#162433; overflow:hidden; margin-top:8px}
Â .bar>span{display:block; height:100%; background:linear-gradient(90deg, #22c55e, #38bdf8)}
Â  /* floating bubble */
Â  #bubble{position:fixed; right:20px; bottom:20px; width:56px; height:56px; background:#22c55e; color:#001b0b; border:none; border-radius:50%;
Â  Â  box-shadow:0 18px 50px rgba(0,0,0,.45); cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:800}
Â  /* maximize */
Â  #max{font-size:18px; width:36px; height:36px; display:grid; place-items:center; border-radius:10px}
</style>
</head>
<body>

<button id="bubble" style="display:none">L</button>

<div id="portal" aria-label="LifeOS Portal v1.2">
Â  <div id="hdr">
Â  Â  <div id="title">LifeOS Architect â€¢ <span class="tag">MICRO v1.2</span></div>
Â  Â  <span class="tag" id="realtimeTag">Real-time STT</span>
Â  Â  <span class="tag" id="ttsTag">TTS Natural</span>
Â  Â  <span class="tag" id="teamTag">Team Mode</span>
Â  Â  <div class="sp"></div>
Â  Â  <button id="max" class="btn" title="Maximize/Restore (or drag corner)">â¤¢</button>
Â  Â  <button id="close" class="btn red" title="Close">âœ•</button>
Â  </div>

Â  Â  <div id="conf" class="row">
Â  Â  <input id="base" placeholder="https://robust-magic-production.up.railway.app" />
Â  Â  <input id="key" placeholder="COMMAND_CENTER_KEY" />
Â  Â  <label id="teamToggle"><input type="checkbox" id="team"/> Team</label>
Â  Â  <button id="ping" class="btn">Ping</button>
Â  Â  <button id="commit" class="btn acc">Commit to GitHub</button>
Â  </div>

Â  <div id="main">
Â  Â  <div id="left">
Â  Â  Â  Â  Â  Â  <div id="io">
Â  Â  Â  Â  <div id="ok" class="pill" style="background:#0f1d12;border-color:#1c3320;color:#b2e3c4">âœ… v1.2 Loaded: Conversational + Hands-free (120s timeout) + Task Progress. Drag corner to resize.</div>
Â  Â  Â  Â  <div class="mono" id="outMicro">â€¢ MICRO log: Ready for commands.</div>
Â  Â  Â  Â  <div class="bubble">
Â  Â  Â  Â  Â  <h5>AI Response</h5>
Â  Â  Â  Â  Â  <div id="out">Ready â€“ Type commands like "build revenue script with details" for step-by-step.</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="inpWrap">
Â  Â  Â  Â  <textarea id="msg" rows="3" placeholder="Type commands conversationally (e.g., 'Give me detailed steps to build X'). Shift+Enter for newlines; Enter sends if toggled. Hold mic or hands-free for voice."></textarea>
Â  Â  Â  Â  <div id="inpCtrls">
Â  Â  Â  Â  Â  <div class="row" style="gap:6px">
Â  Â  Â  Â  Â  Â  <button id="send" class="btn acc">Send</button>
Â  Â  Â  Â  Â  Â  <button id="ptt" class="btn">ðŸŽ¤ Hold to talk</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="switch"><input type="checkbox" id="enterSends" checked /> <label for="enterSends">Enter sends (Shift+Enter = newline)</label></div>
Â  Â  Â  Â  Â  <div class="switch"><input type="checkbox" id="handsfree" /> <label for="handsfree">Hands-free mic <input type="range" id="hfTimeout" min="30" max="300" value="120" title="Timeout (s)"/>s</label></div>
Â  Â  Â  Â  Â  <div class="switch"><input type="checkbox" id="tts" checked /> <label for="tts">Speak replies naturally</label> <button id="stopTts" class="btn red" style="padding:4px 8px">Stop</button></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="right">
Â  Â  Â  <div id="kpi">
Â  Â  Â  Â  <div class="pill" id="roiPill">ROI: â€”</div>
Â  Â  Â  Â  <div class="pill" id="spendPill">Spend: â€”</div>
Â  Â  Â  Â  <div class="pill" id="queuePill">Queue: â€”</div>
Â  Â  Â  </div>
Â  Â  Â  <div id="tasks">
Â  Â  Â  Â  <div class="task" style="text-align:center;color:var(--muted);padding:20px">
Â  Â  Â  Â  Â  <div>Tasks Panel</div>
Â  Â  Â  Â  Â  <div style="font-size:10px">Priority â€¢ Progress Bar (%) â€¢ Summary</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<script>
(() => {
Â  const qs = new URLSearchParams(location.search);
Â  const $ = (id)=>document.getElementById(id);
Â  const base = $('base'); const key = $('key'); const team = $('team');
Â  const out = $('out');Â  Â const outMicro = $('outMicro');
Â  const msg = $('msg');Â  Â const ptt = $('ptt');
Â  const enterSends = $('enterSends'); const handsfree = $('handsfree'); const hfTimeout = $('hfTimeout');
Â  const speakToggle = $('tts'); const stopTtsBtn = $('stopTts');

Â  // Prefill config
Â  base.value = qs.get('base') |

| location.origin;
Â  key.valueÂ  = qs.get('key')Â  |

| '';
Â  team.checked = qs.get('team') === '1';

Â  // Maximize / restore (or drag corner resizes)
Â  let maximized = false;
Â  $('max').onclick = () => {
Â  Â  maximized =!maximized;
Â  Â  if (maximized) {
Â  Â  Â  Object.assign($('portal').style, { right:'0', bottom:'0', width:'100vw', height:'100vh', borderRadius:'0' });
Â  Â  } else {
Â  Â  Â  Object.assign($('portal').style, { right:'24px', bottom:'24px', width:'720px', height:'560px', borderRadius:'16px' });
Â  Â  }
Â  };
Â  $('close').onclick = () => { $('portal').style.display = 'none'; $('bubble').style.display='grid'; };
Â  $('bubble').onclick = () => { $('portal').style.display = 'block'; $('bubble').style.display='none'; };

Â  // Helpers
Â  const logMicro = (label, text) => {
Â  Â  const ts = new Date().toLocaleTimeString();
Â  Â  outMicro.textContent = `${outMicro.textContent}\n${label} ${ts}: ${text}`.slice(-8000);
Â  Â  outMicro.scrollTop = outMicro.scrollHeight;
Â  };
Â  const microEncode = (plain) => {
Â  Â  // Conversational injection for natural, detailed responses like Grok
Â  Â  const convPlain = plain + ' Respond conversationally like Grok: detailed steps, natural tone, no fluff.';
Â  Â  return `V:2.0|OP:G|D:${convPlain.trim().replace(/\s+/g,'~').slice(0,1600)}|T:G|R:~CT~KP`;
Â  };
Â  const microExtractCT = (micro) => {
Â  Â  const m = micro.split('|').find(p => p.startsWith('CT:'));
Â  Â  return m? m.slice(3).replace(/~/g,' ') : micro;
Â  };

Â  async function jfetch(path, init={}){
Â  Â  const b = base.value.replace(/\/+$/,'');
Â  Â  const url = `${b}${path}`;
Â  Â  const r = await fetch(url, init);
Â  Â  const t = await r.text();
Â  Â  if (!r.ok) throw new Error(`${r.status} ${t.slice(0,200)}`);
Â  Â  return t;
Â  }

Â  // Send logic (MICRO - conversational)
Â  async function send(text){
Â  Â  const microOut = microEncode(text);
Â  Â  logMicro('â†’ MICRO OUT', microOut);
Â  Â  const t0 = performance.now();
Â  Â  const resp = await jfetch(`/api/v1/architect/micro?key=${encodeURIComponent(key.value)}${team.checked? '&team=1':''}`, {
Â  Â  Â  method:'POST',
Â  Â  Â  headers:{'Content-Type':'text/plain'},
Â  Â  Â  body: microOut
Â  Â  });
Â  Â  const dt = Math.round(performance.now()-t0);
Â  Â  logMicro('â† MICRO IN', resp);
Â  Â  const ct = microExtractCT(resp);
Â  Â  out.textContent = ct + `\n\n(${dt} ms)`;
Â  Â  if (speakToggle.checked) ttsSpeak(ct);
Â  }

Â  // Enter sends / shift+enter newline (no auto-send on space)
Â  msg.addEventListener('keydown', (e)=>{
Â  Â  if (enterSends.checked && e.key === 'Enter' &&!e.shiftKey){
Â  Â  Â  e.preventDefault(); $('send').click();
Â  Â  }
Â  });
Â  $('send').onclick = async () => {
Â  Â  const text = msg.value.trim();
Â  Â  if (!text) return;
Â  Â  msg.value = '';
Â  Â  await send(text);
Â  };

Â  // Ping
Â  $('ping').onclick = async ()=>{
Â  Â  try{
Â  Â  Â  const t0 = performance.now();
Â  Â  Â  const r = await jfetch(`/healthz?key=${encodeURIComponent(key.value)}`);
Â  Â  Â  const dt = Math.round(performance.now()-t0);
Â  Â  Â  out.textContent = `Server OK in ${dt} ms`;
Â  Â  }catch(e){ out.textContent = 'Ping failed: '+e.message; }
Â  };

Â  // Commit button
Â  $('commit').onclick = ()=>{
Â  Â  const path = prompt('Path to commit (e.g. public/overlay/README.md):');
Â  Â  if (!path) return;
Â  Â  const content = prompt('Paste file content. (OK to continue)');
Â  Â  if (content==null) return;
Â  Â  fetch(`${base.value.replace(/\/+$/,'')}/api/v1/dev/commit?key=${encodeURIComponent(key.value)}`,{
Â  Â  Â  method:'POST', headers:{'Content-Type':'application/json'},
Â  Â  Â  body: JSON.stringify({ path, content, message:`portal commit: ${path}` })
Â  Â  }).then(r=>r.json()).then(j=>{
Â  Â  Â  out.textContent = j.ok? `Committed ${path} (${j.sha||'sha'})` : `Commit error: ${j.error||'unknown'}`;
Â  Â  }).catch(e=> out.textContent = 'Commit failed: '+e.message);
Â  };

Â  // --------- Speech (Web Speech API) ----------
Â  let recog, speaking=false, speechUtterance=null, handsfreeTimer=null;
Â  function setupRecog(){
Â  Â  const SR = window.SpeechRecognition |

| window.webkitSpeechRecognition;
Â  Â  if (!SR) { ptt.disabled = true; $('realtimeTag').textContent='No STT'; return; }
Â  Â  recog = new SR(); recog.lang='en-US'; recog.interimResults=true; recog.continuous=true;
Â  Â  let buf = '';
Â  Â  recog.onresult = (ev)=>{
Â  Â  Â  let final = '';
Â  Â  Â  for (let i=ev.resultIndex; i<ev.results.length; i++){
Â  Â  Â  Â  const r = ev.results[i];
Â  Â  Â  Â  if (r.isFinal) final += r.transcript;
Â  Â  Â  Â  else buf = r.transcript;
Â  Â  Â  }
Â  Â  Â  $('msg').value = (final |

| buf);
Â  Â  };
Â  Â  recog.onend = ()=>{
Â  Â  Â  if (handsfree.checked){
Â  Â  Â  Â  if (!handsfreeTimer) recog.start();
Â  Â  Â  } else {
Â  Â  Â  Â  ptt.classList.remove('acc'); ptt.textContent='ðŸŽ¤ Hold to talk';
Â  Â  Â  }
Â  Â  };
Â  }
Â  setupRecog();

Â  // push-to-talk (hold)
Â  ptt.onmousedown = ()=>{ if (!recog) return; recog.start(); ptt.classList.add('acc'); ptt.textContent='ðŸŽ¤ Listeningâ€¦'; };
Â  ptt.onmouseupÂ  Â = ()=>{ if (!recog) return; try{recog.stop();}catch{} ptt.classList.remove('acc'); ptt.textContent='ðŸŽ¤ Hold to talk'; };

Â  // hands-free (toggle on/off, timeout slider)
Â  handsfree.addEventListener('change', ()=>{
Â  Â  if (!recog){ handsfree.checked = false; return; }
Â  Â  if (handsfree.checked){
Â  Â  Â  recog.start();
Â  Â  Â  ptt.textContent='ðŸŽ¤ Hands-free (timeout: '+hfTimeout.value+'s)';
Â  Â  Â  ptt.classList.add('acc');
Â  Â  Â  if (handsfreeTimer) clearTimeout(handsfreeTimer);
Â  Â  Â  handsfreeTimer = setTimeout(()=>{ try{recog.stop();}catch{} handsfree.checked=false; handsfreeTimer=null; ptt.classList.remove('acc'); ptt.textContent='ðŸŽ¤ Hold to talk'; }, hfTimeout.value * 1000);
Â  Â  } else {
Â  Â  Â  if (handsfreeTimer) { clearTimeout(handsfreeTimer); handsfreeTimer=null; }
Â  Â  Â  try{recog.stop();}catch{}
Â  Â  Â  ptt.classList.remove('acc'); ptt.textContent='ðŸŽ¤ Hold to talk';
Â  Â  }
Â  });
Â  hfTimeout.oninput = ()=>{ if (handsfree.checked) handsfree.dispatchEvent(new Event('change')); }; // Restart timer on slide

Â  // TTS (natural: slower rate, varied pitch)
Â  function ttsSpeak(text){
Â  Â  if (!('speechSynthesis' in window)) return;
Â  Â  try { window.speechSynthesis.cancel(); } catch {}
Â  Â  const u = new SpeechSynthesisUtterance(text);
Â  Â  const voices = speechSynthesis.getVoices();
Â  Â  const pref = voices.find(v => /(Natural|Neural|Google US English|UK English Female)/i.test(v.name)) |

| voices.find(v=>/en/i.test(v.lang));
Â  Â  if (pref) u.voice = pref;
Â  Â  u.rate = 0.95; u.pitch = 0.9 + Math.random()*0.2; // Natural variation
Â  Â  speechSynthesis.speak(u);
Â  Â  speechUtterance = u;
Â  }
Â  stopTtsBtn.onclick = ()=>{ try{speechSynthesis.cancel();}catch{} };

Â  // Tasks panel & KPI (priority badge, % bar)
Â  async function refreshRight(){
Â  Â  try{
Â  Â  Â  const [t, roi] = await Promise.all();
Â  Â  Â  const list = (t.tasks||).slice().reverse();
Â  Â  Â  $('queuePill').textContent = `Queue: ${list.length}`;
Â  Â  Â  if (roi.ok){
Â  Â  Â  Â  $('roiPill').textContent = `ROI: ${(roi.roi.roi_ratio||0).toFixed? (roi.roi.roi_ratio||0).toFixed(2)+'x' : roi.roi.ratio||'â€”'}`;
Â  Â  Â  Â  $('spendPill').textContent = `Spend: $${(roi.roi.daily_spend||0).toFixed? (roi.roi.daily_spend||0).toFixed(2) : roi.roi.daily_spend}`;
Â  Â  Â  }
Â  Â  Â  $('tasks').innerHTML = list.map(task=>{
Â  Â  Â  Â  const pct = task.status==='complete'? 100 : task.status==='in-progress'? 50 : 0;
Â  Â  Â  Â  const prioClass = task.priority === 'high'? 'prio-high' : task.priority === 'med'? 'prio-med' : 'prio-low';
Â  Â  Â  Â  const summary = task.result?.summary |

| '';
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  <div class="task">
Â  Â  Â  Â  Â  Â  <div class="trow">
Â  Â  Â  Â  Â  Â  Â  <div><strong>#${task.id}</strong> â€¢ ${task.description}</div>
Â  Â  Â  Â  Â  Â  Â  <div style="color:${pct===100?'#22c55e':pct===50?'#38bdf8':'#8aa1b2'}">${task.status} (${pct}%)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="trow" style="margin-top:4px">
Â  Â  Â  Â  Â  Â  Â  <div class="prio-badge ${prioClass}">${task.priority |

| 'â€”'}</div>
Â  Â  Â  Â  Â  Â  Â  <div class="pill">Saved: ${task.result?.compression_pct??'â€”'}%</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bar"><span style="width:${pct}%"></span></div>
Â  Â  Â  Â  Â  Â  ${summary? `<div style="margin-top:6px;color:#a6c5d6;font-size:12px">${summary}</div>` : ''}
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  }).join('');
Â  Â  }catch(e){
Â  Â  Â  // silent
Â  Â  }
Â  }
Â  setInterval(refreshRight, 2500); refreshRight();

Â  // auto-send if?q= param
Â  if (qs.get('q')) { msg.value = qs.get('q'); $('send').click(); }
})();
</script>
</body>
</html>
