<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LifeOS Architect ‚Ä¢ MICRO</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#111318; --ink:#eaf2ff; --muted:#9aa4b2; --acc:#22d3ee; --line:#222733; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:transparent;font-family:-apple-system,system-ui,Segoe UI,Roboto,Inter,sans-serif;color:var(--ink)}
    .wrap{position:fixed;inset:auto 20px 20px auto;width:min(720px,calc(100vw - 40px));height:min(72vh,calc(100vh - 40px));display:flex;flex-direction:column;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 24px 80px rgba(0,0,0,.45);overflow:hidden}
    header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
    header h1{font-size:16px;margin:0;color:#b6c3ff}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .grow{flex:1}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:6px}
    .btn{background:var(--acc);color:#001017;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#202635;color:#c9d3ea;border:1px solid var(--line)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
    .input, textarea{width:100%;background:#0c0f14;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px}
    textarea{min-height:90px;max-height:30vh;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
    .log{flex:1;overflow:auto;padding:12px}
    .msg{padding:10px 12px;border:1px solid var(--line);border-radius:10px;margin:8px 0;background:#0b1016}
    .msg.user{border-color:#2a7; background:#0f1a14}
    .msg.ai{border-color:#37a; background:#0e1524}
    .meta{font-size:11px;color:var(--muted);margin-bottom:4px}
    .cfg{padding:10px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>LifeOS Architect ‚Ä¢ MICRO</h1>
      <span class="pill">Real-time STT</span>
      <span class="pill">TTS</span>
      <span class="pill">Team Mode</span>
      <div class="grow"></div>
      <button class="btn ghost" id="closeBtn">‚úï</button>
    </header>

    <div class="cfg">
      <div class="row" style="gap:12px;flex-wrap:wrap;width:100%">
        <input id="base" class="input" placeholder="Base (auto)" style="flex:1;min-width:240px;">
        <input id="key" class="input" placeholder="COMMAND_CENTER_KEY" style="width:260px;">
        <label class="row pill" style="gap:6px;cursor:pointer"><input id="team" type="checkbox"> Team</label>
        <button class="btn secondary" id="testBtn">Ping</button>
        <button class="btn secondary" id="commitBtn">Commit to GitHub</button>
      </div>
    </div>

    <div class="log" id="log"></div>

    <div class="col" style="padding:10px">
      <textarea id="input" placeholder="Type or paste long text here. Hold mic while talking for live transcription."></textarea>
      <div class="row">
        <button class="btn" id="sendBtn">Send</button>
        <button class="btn secondary" id="micBtn">üéôÔ∏è Hold to talk</button>
        <div class="grow"></div>
        <small id="hint">Ready</small>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const $  = (id)=>document.getElementById(id);
    const logBox = $("log");

    $("base").value = qs.get("base") || location.origin;
    $("key").value  = qs.get("key")  || "";
    $("team").checked = qs.get("team")==="1";

    function add(kind, html){
      const div = document.createElement("div");
      div.className = "msg " + kind;
      div.innerHTML = html;
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    }
    function meta(t){ return `<div class="meta">${t}</div>` }

    // ----- Speech-to-text (live) -----
    let rec=null;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR){
      rec = new SR();
      rec.continuous = true;
      rec.interimResults = true;
      rec.lang = "en-US";
      rec.onresult = (e)=>{
        let final = "", interim = "";
        for (let i= e.resultIndex; i<e.results.length; i++){
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) final += t; else interim += t;
        }
        if (interim) $("hint").textContent = "Listening‚Ä¶ " + interim;
        if (final)  { $("input").value += ( $("input").value ? " " : "" ) + final.trim(); $("hint").textContent = "Captured"; }
      };
      $("micBtn").onmousedown = ()=>{ $("hint").textContent="Listening‚Ä¶"; rec.start(); };
      $("micBtn").onmouseup   = ()=>{ try{ rec.stop(); }catch{} $("hint").textContent="Stopped"; };
      $("micBtn").onmouseleave= ()=>{ try{ rec.stop(); }catch{} $("hint").textContent="Stopped"; };
      $("micBtn").ontouchstart= (e)=>{ e.preventDefault(); $("hint").textContent="Listening‚Ä¶"; rec.start(); };
      $("micBtn").ontouchend  = (e)=>{ e.preventDefault(); try{ rec.stop(); }catch{} $("hint").textContent="Stopped"; };
    } else {
      $("micBtn").disabled = true; $("micBtn").textContent = "No mic API";
    }

    // ----- TTS -----
    function speak(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch{}
    }

    function buildMicro(text){
      // very light MICRO encoder for chat
      const t = String(text || "").trim();
      return `V:2.0|OP:G|D:${t.replace(/\s+/g,"~").slice(0,80)}|T:G|R:~CT~KP`;
    }

    async function postMicro(micro){
      const base = $("base").value.trim().replace(/\/+$/,'');
      const key  = $("key").value.trim();
      const team = $("team").checked ? "&team=1" : "";
      const url  = `${base}/api/v1/architect/micro?key=${encodeURIComponent(key)}${team}`;
      const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"text/plain" }, body: micro });
      const text = await r.text();
      if (!r.ok) throw new Error(text || `HTTP ${r.status}`);
      return text;
    }

    function parseCT(micro){
      const m = /CT:([^|]+)/.exec(micro);
      return m ? m[1].replace(/~/g," ") : micro;
    }

    $("sendBtn").onclick = async ()=>{
      const msg = $("input").value.trim();
      if (!msg) return;
      add("user", meta("YOU") + msg);
      $("input").value = "";
      const microOut = buildMicro(msg);
      add("ai", meta("‚Üí MICRO OUT") + `<code>${microOut}</code>`);
      try{
        const microIn = await postMicro(microOut);
        add("ai", meta("‚Üê MICRO IN") + `<code>${microIn}</code>`);
        const text = parseCT(microIn);
        add("ai", meta("AI") + text);
        speak(text);
      }catch(e){
        add("ai", meta("ERROR") + String(e));
      }
    };
    $("input").addEventListener("keydown", (e)=>{ if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) $("sendBtn").click(); });

    // ---- Test button ----
    $("testBtn").onclick = async ()=>{
      try{
        const res = await fetch(($("base").value||location.origin).replace(/\/+$/,'') + "/health");
        add("ai", meta("Ping") + (res.ok ? "Server OK" : "Server error"));
      }catch(e){ add("ai", meta("Ping") + String(e)); }
    };

    // ---- Commit to GitHub (from overlay) ----
    $("commitBtn").onclick = async ()=>{
      const content = prompt("Paste FULL file content to commit (it will be base64'd on server).");
      if (content == null) return;
      const filePath = prompt("Repo path (e.g. server.js or public/overlay/portal.html):", "server.js");
      if (!filePath) return;
      const base = $("base").value.trim().replace(/\/+$/,'');
      const key  = $("key").value.trim();
      try{
        const r = await fetch(`${base}/api/v1/dev/commit?key=${encodeURIComponent(key)}`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ path:filePath, content, message:`feat: update ${filePath} (via overlay)` })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "Commit failed");
        add("ai", meta("Commit") + `Committed ${filePath} ‚Ä¢ sha ${j.sha || "(unknown)"}`);
      }catch(e){
        add("ai", meta("Commit ERROR") + String(e));
      }
    };

    // Show a ready line
    add("ai", meta("Overlay") + "Overlay loaded. Paste or talk, then Send. Team=Claude+GPT+Judge.");
    // Prefill base/key from URL
    if (!qs.get("base")) $("base").value = location.origin;
    if (qs.get("key")) add("ai", meta("Key") + "Loaded key from URL.");
    // Close button
    $("closeBtn").onclick = ()=>{ try{ speechSynthesis.cancel(); }catch{} document.getElementById("app").remove(); };
  </script>
</body>
</html>
